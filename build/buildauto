#!/bin/bash
export PATH="/usr/local/bin:/usr/bin:/bin:/usr/games"

cd $(dirname $0)

if [ ! "$INIT" ]; then
	export SCRIPT=$(echo "$0")
	../headerfile
	exit 0
fi

# ::::::::::::::::::::::::::::::::::::::::::::::

if ( ! cat $LOCAL/config/scriptrepo &> /dev/null ) \
&& ( ! cat $LOCAL/config/scriptdevice &> /dev/null  ); then
	echo "Both Auto Builder's repository and device is not set!"
	echo "Please use the Auto Builder config menu"
	read -p "[Press Enter]: " done
	exit 0
elif ( ! cat $LOCAL/config/scriptrepo &> /dev/null  ); then
	echo "Auto Builder's repository is not set!"
	echo "Please use the Auto Builder config menu"
	read -p "[Press Enter]: " done
	exit 0
elif ( ! cat $LOCAL/config/scriptdevice &> /dev/null  ); then
	echo "Auto Builder's device is not set!"
	echo "Please use the Auto Builder config menu"
	read -p "[Press Enter]: " done
	exit 0
fi

# ::::::::::::::::::::::::::::::::::::::::::::::

export AUTO=true

if [ $(cat $LOCAL/config/outfile | head -n 1) == "" ]; then
	outfile=$(echo $LOCAL/..)
else
	outfile=$(cat $LOCAL/config/outfile | head -n 1)
fi

reposync kitchen > $outfile/buildoutput.txt 2>&1
reposync $SCRIPT_REPO >> $outfile/buildoutput.txt 2>&1

setupandro >> $outfile 2>&1

# ::::::::::::::::::::::::::::::::::::::::::::::

echo "EOF" >> $LOCAL/config/scriptrepo

while true; do
	let repocount=$repocount+1
	scriptrepo[$repocount]=$( cat $LOCAL/config/scriptrepo | sed -n "$repocount"p )

	if [ "${scriptrepo[$repocount]}" == "EOF" ]; then
		break
	fi
done

sed -i "/EOF/d" $LOCAL/config/scriptrepo

# ::::::::::::::::::::::::::::::::::::::::::::::

echo "EOF" >> $LOCAL/config/scriptdevice

while true; do
	let devicecount=$devicecount+1
	scriptdevice[$devicecount]=$( cat $LOCAL/config/scriptdevice | sed -n "$devicecount"p )

	if [ "${scriptdevice[$devicecount]}" == "EOF" ]; then
		break
	fi
done

sed -i "/EOF/d" $LOCAL/config/scriptdevice

# ::::::::::::::::::::::::::::::::::::::::::::::

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
while true; do
	let repocountdown=$repocountdown+1
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	export SCRIPT_REPO="${scriptrepo[$repocount]}"
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	while true; do
		let devicecountdown=$devicecountdown+1
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		export SCRIPT_DEVICE="${scriptdevice[$devicecount]}"
		buildandro >> $outfile/buildoutput.txt 2>&1
		setupprop >> $outfile/buildoutput.txt 2>&1
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		if [ $devicecountdown == $( expr $devicecount - 1 ) ]; then
			break
		fi
	done
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	if [ $repocountdown == $( expr $repocount - 1 ) ]; then
		break
	fi
done
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# ::::::::::::::::::::::::::::::::::::::::::::::

if ( find $BUILDS/../publish &> /dev/null); then
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	while true; do
		let repocountdown=$repocountdown+1
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		export SCRIPT_REPO="${scriptrepo[$repocount]}"
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		while true; do
			let devicecountdown=$devicecountdown+1
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
			export SCRIPT_DEVICE="${scriptdevice[$devicecount]}"
			publishandro >> $outfile/buildoutput.txt 2>&1
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
			if [ $devicecountdown == $( expr $devicecount - 1 ) ]; then
				break
			fi
		done
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		if [ $repocountdown == $( expr $repocount - 1 ) ]; then
			break
		fi
	done
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
fi

# ::::::::::::::::::::::::::::::::::::::::::::::

if ( find $LOCAL/config/sleepybuildserver ); then
	echo "" >> $outfile/buildoutput.txt 2>&1
	echo "Waiting for ten minutes! this is not a countdown.." >> $outfile/buildoutput.txt 2>&1
	sleep 10m
	echo "Sleep..." >> $outfile/buildoutput.txt 2>&1

	sleeptime=$( cat $LOCAL/config/sleepybuildserver | sed -n 1p )
	passy=$( cat $LOCAL/config/sleepybuildserver | sed -n 2p )

	echo $passy | sudo -S rtcwake -n -l -m mem -s 46800 > $sleeptime/sleeptime.txt 2>&1
	sleep 30
	echo $passy | sudo -S rtcwake -l -m mem -s 46800 >> $sleeptime/sleeptime.txt 2>&1
fi
