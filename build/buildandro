#!/bin/bash
# Written by Sean Donovan (swordrune10)
if [ ! "$OTHER_REPO_FOLDER" == "" ]; then
	outfolder=$(echo "$OTHER_REPO_FOLDER/out/target/product/$SCRIPT_DEVICE/system")
else
	outfolder=$(echo "$REPOS/$SCRIPT_REPO-$REPO_PLATFORM/out/target/product/$SCRIPT_DEVICE/system")
fi

if ( find $outfolder/build.prop &> /dev/null ); then
	rm $outfolder/build.prop
fi
cd ..
if ( find $outfolder/*.zip &> /dev/null ); then
	rm $outfolder/*.zip*
fi

if [ ! "$OTHER_REPO_FOLDER" == "" ]; then
	cd $OTHER_REPO_FOLDER
else
	cd $REPOS/$SCRIPT_REPO-$REPO_PLATFORM
fi

. build/envsetup.sh

if [ $SCRIPT_REPO == "cm" ] || [ $SCRIPT_REPO == "sts" ]; then
	brunch $SCRIPT_DEVICE -j$THREADS_TOTAL
	exit 0
fi

if ( find vendor/*/vendorsetup.sh &> /dev/null ); then
	vendor_lunch=$(sed -e 's/add_lunch_combo //g' \
	-e 's/_.*/_/' \
	vendor/*/vendorsetup.sh | sed "/#.*/d" | sed "/combo.*/d" | sed "/panda.*/d" | sed "/^$/d" | head -n 1)
elif ( find device/*/*/vendorsetup.sh &> /dev/null ); then
		vendor_lunch=$(sed -e 's/add_lunch_combo //g' \
		-e 's/_.*/_/' \
		device/*/*/vendorsetup.sh | sed "/#.*/d" | sed "/combo.*/d" | sed "/panda.*/d" | sed "/^$/d" | head -n 1)
	else
		echo "Repository not supported!"
		read -p "Press Enter to continue: " done
		exit 0
fi

lunch $vendor_lunch$SCRIPT_DEVICE-userdebug
make CC=gcc-4.4 CXX=g++-4.4 otapackage -j$THREADS_TOTAL
